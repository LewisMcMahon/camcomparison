<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cam Comparison</title>

<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.10/css/jquery.dataTables.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" type="text/css" href="css/style.css">

<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>  
<script type="text/javascript" charset="utf8" src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>  

<script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.js"></script>

<script src="js/jquery.textfill.min.js"></script>

</head>
<body>

<script>

	//custom sorting for range
	jQuery.extend( jQuery.fn.dataTableExt.oSort, {	     
	    "size-range-asc": function( a, b ) {	    	
	    	a = a.split("-")
	    	a[0] = parseFloat(a[0])
	    	a[1] = parseFloat(a[1])
	    	
	    	b = b.split("-")
	    	b[0] = parseFloat(b[0])
	    	b[1] = parseFloat(b[1])
	    	
	        return ((a[0] < b[0]) ? -1 : ((a[0] > b[0]) ? 1 : 0));
	    },
	 
	    "size-range-desc": function(a,b) {
	    	a = a.split("-")
	    	a[0] = parseFloat(a[0])
	    	a[1] = parseFloat(a[1])
	    	
	    	b = b.split("-")
	    	b[0] = parseFloat(b[0])
	    	b[1] = parseFloat(b[1])
	    	
	        return ((a[1] < b[1]) ? 1 : ((a[1] > b[1]) ? -1 : 0));
	    }
	} );
	
	function buildRangeCollum() {
		
		var minCamSize = false
	    var maxCamSize = false
	    
	    var colors = []
		colors["blue"] = "#216EA6"
		colors["silver"] = "#E9E4E0"
		colors["purple"] = "#B15DA8"
		colors["green"] = "#47954A"
		colors["red"] = "#CD4843"
		colors["gold"] = "#E4B05D"
		
		//get min and max cam sizes		
		$( "#camTable tr td:nth-child(4)" ).each(function( index ) {
	    	var camRange = $( this ).text().split("-")	    	
	    	camRange[0] = parseFloat(camRange[0])
	    	camRange[1] = parseFloat(camRange[1])
	    	
	    	if (minCamSize == false || camRange[0] < minCamSize){
	       		minCamSize = camRange[0]
	       	}	        	
	      	if (maxCamSize == false || maxCamSize < camRange[1]){
	       		maxCamSize = camRange[1]
	    	}	      	
		});
				
		//calculate %   
	    var totalCamRange = maxCamSize - minCamSize	    
	    var rangeCollWidth = 100
	    var camRangeMMPerPx =  rangeCollWidth/totalCamRange
	    
	    var camTable = $('#camTable').DataTable();
		
	    //create range graph
	    camTable.rows().eq(0).each( function ( index ) {
	        var row = camTable.row( index );
	        
	        var data = row.data();
	        var rangeTdNode = $(row.node()).children('td:nth-child(4)')    	

	    	var rangeText = data[3]
	    	var camRange = data[3].split("-")
	    	camRange[0] = parseFloat(camRange[0])
	    	camRange[1] = parseFloat(camRange[1])
	    	rangeTdNode.text("")
	    	html = ""
	    	html +="<div class='rangeCell fistSizeDiv'> </div>"
	    	html +="<div class='rangeCell mainSizeDiv' style='background-color:"+colors[data[11]]+"' title='"+rangeText+"'><span>"+rangeText+"</span></div>"
	    	html +="<div class='rangeCell lastSizeDiv'> </div>"	    	
	    	rangeTdNode.attr("data-search", rangeText);
	    	rangeTdNode.attr("data-order", rangeText); 
	    	rangeTdNode.append(html)
	    	
	    	var fistSizeDivSize = (camRange[0]-minCamSize)*camRangeMMPerPx
	    	var lastSizeDivSize = (maxCamSize-camRange[1])*camRangeMMPerPx
	    	var mainSizeDivSize = rangeCollWidth-(fistSizeDivSize+lastSizeDivSize)		    	
	    	
	    	rangeTdNode.find('.fistSizeDiv:first').width(fistSizeDivSize+"%")
	    	rangeTdNode.find('.lastSizeDiv:first').width(lastSizeDivSize+"%")
	    	rangeTdNode.find('.mainSizeDiv:first').width(mainSizeDivSize+"%")
	    });	
	    
	    //building range scale
	    $(".scaleSection").remove();
	    var rangeScaleSectionSize = totalCamRange/10
	    for(var i = 0; i < 9; i++) {
	    	var scaleNumber = Math.round((rangeScaleSectionSize*i)+minCamSize)
	    	var html = "<div class='scaleSection'>"+scaleNumber+"mm</div>"
	    	
	    	$(".rangeScale").append(html);
	    }
	    $(".rangeScale").append("<div class='scaleSection'>"+maxCamSize+"mm</div>");
	    
	    //adding tooltips
	    $(function() {
	        $('.mainSizeDiv').tooltip();
      	});
		
	    //auto resize text
	    $('.mainSizeDiv').children('span').show()
	    $('.mainSizeDiv').textfill({
	    	minFontPixels : 1,
	    	changeLineHeight : true,
	        fail: function(failedDiv) {
	        	$(failedDiv).children('span').hide()
	        }
	    });
	    
	}
	
	
	function fillAdvancedSearchOptions(){
		
		var camTable = $('#camTable').DataTable();
		
		//manufacturer
		$("#manufacturerSearchOption option").remove();
		$('#manufacturerSearchOption').append( $('<option value="">All</option>') );
		
		var currentSearchTerm = camTable.column(0).search()
		camTable.column(0, {page:'all',search:'none'}).data().unique().sort().each( function( val ) {
			var html = ""
			html += '<option value="'+val+'" '			
			if(val==currentSearchTerm){
				html += 'selected="selected"'
			}			
			html += ' >'+val+'</option>'
			
			$('#manufacturerSearchOption').append( html );
		} );
		
		//Model
		$("#modelSearchOption option").remove();
		$('#modelSearchOption').append( $('<option value="">All</option>') );
		
		var currentSearchTerm = camTable.column(1).search()
		camTable.column(1, {page:'all',search:'applied'}).data().unique().sort().each( function( val ) {
			var html = ""
			html += '<option value="'+val+'" '			
			if(val==currentSearchTerm){
				html += 'selected="selected"'
			}			
			html += ' >'+val+'</option>'
			
			$('#modelSearchOption').append( html );
		} );
		
		//Name
		$("#nameSearchOption option").remove();
		$('#nameSearchOption').append( $('<option value="">All</option>') );
		
		var currentSearchTerm = camTable.column(2).search()
		camTable.column(2, {page:'all',search:'applied'}).data().unique().sort().each( function( val ) {
			var html = ""
			html += '<option value="'+val+'" '			
			if(val==currentSearchTerm){
				html += 'selected="selected"'
			}			
			html += ' >'+val+'</option>'
			
			$('#nameSearchOption').append( html );
		} );
		
		
	    
	}
	
	function importData(){
		
		var currencySymbols = []
		currencySymbols["USD"] = "$"
		currencySymbols["GBP"] = "£"
		currencySymbols["EUR"] = "€"
		
		var camTable = $('#camTable').DataTable();
		camTable.clear();
		
		var selectedCurrency = $('#currencyInput').val()
		
		//Import Data and create base html table
		$.getJSON("cams.json", function(result){			
	        $.each(result, function(i, cam){
	        	row = camTable.row.add([
                 	cam["manufacturer"],
                   	cam["name"],
                   	cam["variant"],
                   	cam["range"][0]+'-'+cam["range"][1],
                   	currencySymbols[selectedCurrency]+cam["price"][selectedCurrency],
                   	cam["weight"]+"g",
                   	cam["strength"]+"kN",
                   	cam["stemNumber"],
                   	cam["axleNumber"],
                   	cam["extendableSling"],
					cam["offset"],
                 	cam["color"]
                   ])
	        });
	        
	        camTable.draw()
	    
		});
	}


	$(document).ready(function() {
		
		//range search function
   		$.fn.dataTable.ext.search.push(
		    function( settings, data, dataIndex ) {
		        var rangeContains =  $('#rangeInput').val() 	       	
		 		
		        if (!rangeContains){
		        	return true;
		        }
		        rangeContains = parseInt(rangeContains)
		        if(!$.isNumeric( rangeContains )){
		        	return true;
		        }			    
		        
	        	var camRange =  data[3].split("-")
		    	camRange[0] = parseFloat(camRange[0])
		    	camRange[1] = parseFloat(camRange[1])
		    	
		    	if (camRange[0] <= rangeContains && camRange[1] >= rangeContains){
		    		return true;
		    	}
		    	return false;			        
		    }
		);
		
   		//price search function
   		$.fn.dataTable.ext.search.push(
		    function( settings, data, dataIndex ) {
		        var lessThanPrice =  $('#priceInput').val() 	       	
		 		
		        if (!lessThanPrice){
		        	return true;
		        }
		        lessThanPrice = parseInt(lessThanPrice)
		        if(!$.isNumeric( lessThanPrice )){
		        	return true;
		        }		        
		    	
		    	if (data[4].replace(/\D/g,'') <= lessThanPrice){
		    		return true;
		    	}
		    	return false;			        
	    	}
		);
   		
   		//weight search function
   		$.fn.dataTable.ext.search.push(
		    function( settings, data, dataIndex ) {
		        var lessThanWeight =  $('#weightInput').val() 	       	
		 		
		        if (!lessThanWeight){
		        	return true;
		        }
		        lessThanWeight = parseInt(lessThanWeight)
		        if(!$.isNumeric( lessThanWeight )){
		        	return true;
		        }
		    	
		    	if (data[5].replace(/\D/g,'') <= lessThanWeight){
		    		return true;
		    	}
		    	return false;			        
	    	}
		);
   		
   		//strength search function
   		$.fn.dataTable.ext.search.push(
		    function( settings, data, dataIndex ) {
		        var greaterThanStrength =  $('#strengthInput').val() 	       	
		 		
		        if (!greaterThanStrength){
		        	return true;
		        }
		        greaterThanStrength = parseInt(greaterThanStrength)
		        if(!$.isNumeric( greaterThanStrength )){
		        	return true;
		        }
		    	
		    	if (data[6].replace(/\D/g,'') >= greaterThanStrength){
		    		return true;
		    	}
		    	return false;			        
	    	}
		);
		
		//initialse data table
	   	$('#camTable').DataTable( {
	        "bFilter" : true,
	        "bPaginate" : false,
	        "sDom" : 'tp',
	        "columns": [
 	                { orderData: [ 0, 1 , 2]},
 	                { orderData: [ 1, 0 , 2]},
 	                { orderData: [ 2, 1 , 0]},
 	                { "type": "size-range"},
 	                { },
 	                { "visible": false },
 	                { "visible": false },
 	                { "visible": false },
 	                { "visible": false },
 	                { "visible": false },
 	                { "visible": false },
 	               	{ "visible": false }
    		]
	    });
    
	    importData();
	
	    
	    //event defenitions		    
   		var camTable = $('#camTable').DataTable();
   		camTable.on( 'draw', function () {
	    	buildRangeCollum()
	    	fillAdvancedSearchOptions()
	    } );
   		
   		$('#manufacturerSearchOption').on( 'change', function () {
			camTable
			.column(0)
			.search( $(this).val() )
			camTable
			.column(1)
			.search("")
			camTable
			.column(2)
			.search("")				
			
            camTable.draw();
        } );
   		
   		$('#modelSearchOption').on( 'change', function () {
			camTable
			.column(1)
			.search( $(this).val() )				
			camTable
			.column(2)
			.search("")
            
			camTable.draw();
        } );
   		
   		$('#nameSearchOption').on( 'change', function () {
			camTable
			.column(2)
			.search( $(this).val() )
            .draw();
        } );		    
   			   		
	    
   		$('#rangeInput').keyup( function() {
   			camTable.draw();
   	    } );
   		
   		$('#priceInput').keyup( function() {
   			camTable.draw();
   	    } );
   		
   		$('#weightInput').keyup( function() {
   			camTable.draw();
   	    } );
   		
   		$('#strengthInput').keyup( function() {
   			camTable.draw();
   	    } );
   		
   		$('#stemCountInput').on( 'change', function () {
			camTable
			.column(7)
			.search( $(this).val() )
            .draw();
        } );
   		
   		$('#axleCountInput').on( 'change', function () {
			camTable
			.column(8)
			.search( $(this).val() )
            .draw();
        } );
   		
   		$('#extendableSlingInput').on( 'change', function () {
			camTable
			.column(9)
			.search( $(this).val() )
            .draw();
        } );
   		
   		$('#offsetInput').on( 'change', function () {
			camTable
			.column(10)
			.search( $(this).val() )
            .draw();
        } );
   		
   		$('#showExtraData').on( 'click', function () {
   			
   			console.log(camTable.columns(5).visible()[0])
   			if (camTable.columns(5).visible()[0]){
   				camTable
				.columns([5,6,7,8,9,10])
				.visible(false)
				$('#showExtraData').text("Show Extra Data")
   			}
   			else{
   				camTable
				.columns([5,6,7,8,9,10])
				.visible(true)
				$('#showExtraData').text("Hide Extra Data")
   			}
   			buildRangeCollum()
			
        } );
   		
   		$('#currencyInput').on( 'change', function () {
   			importData()
        } );
   		
	} );
</script>

<table id="camTable" class="display" cellspacing="0" width="100%">
	<thead>
		<tr>
			<th>Manufacturer</th>
			<th>Model</th>
			<th>Name</th>
			<th class="rangeHeader" width="100%"><span>Range</span>
				<div class="rangeScale"></div>
			</th>
			<th>Price</th>
			<th>Weight</th>
			<th>Strength</th>
			<th>Stem Count</th>
			<th>Axle Count</th>
			<th>Extendable Sling</th>
			<th>Is Offset</th>
		</tr>
	</thead>
	<tfoot>
		<tr>
			<th>Manufacturer</th>
			<th>Model</th>
			<th>Name</th>
			<th class="rangeHeader" width="100%">
				<div class="rangeScale"></div>
				<span>Range</span>
			</th>
			<th>Price</th>
			<th>Weight</th>
			<th>Strength</th>
			<th>Stem Count</th>
			<th>Axle Count</th>
			<th>Extendable Sling</th>
			<th>Is Offset</th>
		</tr>
	</tfoot>
	<tbody></tbody>
</table>

<div id="advancedSearch">

	<select id="manufacturerSearchOption"></select>
	<select id="modelSearchOption"></select>
	<select id="nameSearchOption"></select>
	<input id="rangeInput" ></input>
	<input id="priceInput" ></input>
	<input id="weightInput" ></input>
	<input id="strengthInput" ></input>
	<select id="stemCountInput">
		<option value="">All</option>
		<option value="1">1</option>
		<option value="2">2</option>
	</select>
	<select id="axleCountInput">
		<option value="">All</option>
		<option value="1">1</option>
		<option value="2">2</option>
	</select>
	<select id="extendableSlingInput">
		<option value="">All</option>
		<option value="Yes">Yes</option>
		<option value="No">No</option>
	</select>
	<select id="offsetInput">
		<option value="">All</option>
		<option value="Yes">Yes</option>
		<option value="No">No</option>
	</select>
	
	<select id="currencyInput">
		<option value="USD">USD</option>
		<option value="GBP">GBP</option>
		<option value="EUR">EUR</option>
	</select>
	
	<div id="showExtraData">Show Extra Data</div>

</div>

</body>
</html>