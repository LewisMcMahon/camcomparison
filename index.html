<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cam Comparison</title>

<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.10/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="css/style.css">

<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>  
<script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.js"></script>

</head>
<body>

<script>

	//custom sorting for range
	jQuery.extend( jQuery.fn.dataTableExt.oSort, {	     
	    "size-range-asc": function( a, b ) {	    	
	    	a = a.split("-")
	    	a[0] = parseFloat(a[0])
	    	a[1] = parseFloat(a[1])
	    	
	    	b = b.split("-")
	    	b[0] = parseFloat(b[0])
	    	b[1] = parseFloat(b[1])
	    	
	        return ((a[0] < b[0]) ? -1 : ((a[0] > b[0]) ? 1 : 0));
	    },
	 
	    "size-range-desc": function(a,b) {
	    	a = a.split("-")
	    	a[0] = parseFloat(a[0])
	    	a[1] = parseFloat(a[1])
	    	
	    	b = b.split("-")
	    	b[0] = parseFloat(b[0])
	    	b[1] = parseFloat(b[1])
	    	
	        return ((a[1] < b[1]) ? 1 : ((a[1] > b[1]) ? -1 : 0));
	    }
	} );
	
	function buildRangeCollum() {
		
		var minCamSize = false
	    var maxCamSize = false
		
		//get min and max cam sizes		
		$( "#camTable tbody .rangeCell" ).each(function( index ) {	    	
	    	var camRange = $( this ).attr( 'data-order' ).split("-")	    	
	    	camRange[0] = parseFloat(camRange[0])
	    	camRange[1] = parseFloat(camRange[1])
	    	
	    	if (minCamSize == false || camRange[0] < minCamSize){
	       		minCamSize = camRange[0]
	       	}	        	
	      	if (maxCamSize == false || maxCamSize < camRange[1]){
	       		maxCamSize = camRange[1]
	    	}	        	
		});
				
		//calculate %   
	    var totalCamRange = maxCamSize - minCamSize	    
	    var rangeCollWidth = 100
	    var camRangeMMPerPx =  rangeCollWidth/totalCamRange
	    
	    //crete range graph
	    $( "#camTable tbody .rangeCell" ).each(function( index ) {
	    	
	    	var camRange = $( this ).attr( 'data-order' ).split("-")
	    	camRange[0] = parseFloat(camRange[0])
	    	camRange[1] = parseFloat(camRange[1])
	    	
	    	var fistSizeDivSize = (camRange[0]-minCamSize)*camRangeMMPerPx
	    	var lastSizeDivSize = (maxCamSize-camRange[1])*camRangeMMPerPx
	    	var mainSizeDivSize = rangeCollWidth-(fistSizeDivSize+lastSizeDivSize)		    	
	    	
	    	$( this ).find('.fistSizeDiv:first').width(fistSizeDivSize+"%")
	    	$( this ).find('.lastSizeDiv:first').width(lastSizeDivSize+"%")
	    	$( this ).find('.mainSizeDiv:first').width(mainSizeDivSize+"%")
	    });	
	    
	    //building range scale
	    $(".scaleSection").remove();
	    var rangeScaleSectionSize = totalCamRange/10
	    for(var i = 0; i < 9; i++) {
	    	var scaleNumber = Math.round((rangeScaleSectionSize*i)+minCamSize)
	    	var html = "<div class='scaleSection'>"+scaleNumber+"mm</div>"
	    	
	    	$(".rangeScale").append(html);
	    }
	    $(".rangeScale").append("<div class='scaleSection'>"+maxCamSize+"mm</div>");
		
	}
	
	
	function fillAdvancedSearchOptions(){
		
		var camTable = $('#camTable').DataTable();
		
		//manufacturer
		$("#manufacturerSearchOption option").remove();
		$('#manufacturerSearchOption').append( $('<option value="">All</option>') );
		
		var currentSearchTerm = camTable.column(0).search()
		camTable.column(0, {page:'all',search:'none'}).data().unique().sort().each( function( val ) {
			var html = ""
			html += '<option value="'+val+'" '			
			if(val==currentSearchTerm){
				html += 'selected="selected"'
			}			
			html += ' >'+val+'</option>'
			
			$('#manufacturerSearchOption').append( html );
		} );
		
		//Model
		$("#modelSearchOption option").remove();
		$('#modelSearchOption').append( $('<option value="">All</option>') );
		
		var currentSearchTerm = camTable.column(1).search()
		camTable.column(1, {page:'all',search:'applied'}).data().unique().sort().each( function( val ) {
			var html = ""
			html += '<option value="'+val+'" '			
			if(val==currentSearchTerm){
				html += 'selected="selected"'
			}			
			html += ' >'+val+'</option>'
			
			$('#modelSearchOption').append( html );
		} );
		
		//Name
		$("#nameSearchOption option").remove();
		$('#nameSearchOption').append( $('<option value="">All</option>') );
		
		var currentSearchTerm = camTable.column(2).search()
		camTable.column(2, {page:'all',search:'applied'}).data().unique().sort().each( function( val ) {
			var html = ""
			html += '<option value="'+val+'" '			
			if(val==currentSearchTerm){
				html += 'selected="selected"'
			}			
			html += ' >'+val+'</option>'
			
			$('#nameSearchOption').append( html );
		} );
		
		
	    
	}

	$(document).ready(function() {
		
		//range search function
   		$.fn.dataTable.ext.search.push(
			    function( settings, data, dataIndex ) {
			        var rangeContains =  $('#rangeInput').val() 	       	
			 		
			        if (!rangeContains){
			        	return true;
			        }
			        rangeContains = parseInt(rangeContains)
			        if(!$.isNumeric( rangeContains )){
			        	return true;
			        }			    
			        
		        	var camRange =  data[3].split("-")
 			    	camRange[0] = parseFloat(camRange[0])
 			    	camRange[1] = parseFloat(camRange[1])
 			    	
 			    	if (camRange[0] <= rangeContains && camRange[1] >= rangeContains){
 			    		return true;
 			    	}
 			    	return false;			        
			    }
			);
	    
	    var colors = []
		colors["blue"] = "#216EA6"
		colors["silver"] = "#E9E4E0"
		colors["purple"] = "#B15DA8"
		colors["green"] = "#47954A"
		colors["red"] = "#CD4843"
		colors["gold"] = "#E4B05D"
		
		//Import Data and create base html table
		$.getJSON("cams.json", function(result){			
	        $.each(result, function(i, cam){
	        	
	        	var html = ""	        	
	        	html += "<tr>"
	        	html += "<td class='manufacturerCell'>"+cam["manufacturer"]+"</td>"
	        	html += "<td class='modelCell'>"+cam["name"]+"</td>"
	        	html += "<td class='nameCell'>"+cam["variant"]+"</td>"
	        	html += '<td class="rangeCell" data-order='+cam["range"][0]+'-'+cam["range"][1]+' data-search='+cam["range"][0]+'-'+cam["range"][1]+'><div class="fistSizeDiv"></div><div style="background-color:'+colors[cam["color"]]+';" class="mainSizeDiv">'+cam["range"][0]+' - '+cam["range"][1]+'</div><div class="lastSizeDiv"></div></td>'      	
	        	html += "<td class='priceCell' data-order='"+cam["price"]["USD"]+"' data-search='"+cam["price"]["USD"]+"'>"+cam["price"]["USD"]+"</td>"
	        	html += "<td class='weightCell' data-order='"+cam["weight"]+"' data-search='"+cam["weight"]+"'>"+cam["weight"]+"g</td>"
	        	html += "<td class='strengthCell' data-order='"+cam["strength"]+"' data-search='"+cam["strength"]+"'>"+cam["strength"]+"kN</td>"
	        	html += "<td class='stemNumberCell'>"+cam["stemNumber"]+"</td>"
	        	html += "<td class='axleNumberCell'>"+cam["axleNumber"]+"</td>"
	        	html += "<td class='extendableSling'>"+cam["extendableSling"]+"</td>"
	        	html += "<td class='offset'>"+cam["offset"]+"</td>"
	        	html += "</tr>"
	        	
	            $("#camTable tbody").append(html);
	        });
	    
		    //initialse data table
		   	$('#camTable').DataTable( {
		        "bFilter" : true,
		        "bPaginate" : false,
		        "sDom" : 'tp',
		        "columns": [
	    	                { orderData: [ 0, 1 , 2]},
	    	                { orderData: [ 1, 0 , 2]},
	    	                { orderData: [ 2, 1 , 0]},
	    	                { "type": "size-range"},
	    	                { },
	    	                { },
	    	                { },
	    	                { },
	    	                { },
	    	                { },
	    	                { }
	    		]
		    });
		   
		    //build range collum for first time
		    buildRangeCollum()
		    fillAdvancedSearchOptions()
		    
		    //event defenitions		    
	   		var camTable = $('#camTable').DataTable();
	   		camTable.on( 'draw', function () {
		    	buildRangeCollum()
		    	fillAdvancedSearchOptions()
		    } );
	   		
	   		$('#manufacturerSearchOption').on( 'change', function () {
				camTable
				.column(0)
				.search( $(this).val() )
				camTable
				.column(1)
				.search("")
				camTable
				.column(2)
				.search("")				
				
	            camTable.draw();
	        } );
	   		
	   		$('#modelSearchOption').on( 'change', function () {
				camTable
				.column(1)
				.search( $(this).val() )				
				camTable
				.column(2)
				.search("")
	            
				camTable.draw();
	        } );
	   		
	   		$('#nameSearchOption').on( 'change', function () {
				camTable
				.column(2)
				.search( $(this).val() )
	            .draw();
	        } );		    
	   			   		
		    
	   		$('#rangeInput').keyup( function() {
	   			camTable.draw();
	   	    } );
		});	    
	    
		
	} );
</script>

<table id="camTable" class="display" cellspacing="0" width="100%">
	<thead>
		<tr>
			<th>Manufacturer</th>
			<th>Model</th>
			<th>Name</th>
			<th class="rangeHeader" width="100%"><span>Range</span>
				<div class="rangeScale"></div>
			</th>
			<th>Price</th>
			<th>Weight</th>
			<th>Strength</th>
			<th>Stem Count</th>
			<th>Axle Count</th>
			<th>Extendable Sling</th>
			<th>Is Offset</th>
		</tr>
	</thead>
	<tfoot>
		<tr>
			<th>Manufacturer</th>
			<th>Model</th>
			<th>Name</th>
			<th class="rangeHeader" width="100%">
				<div class="rangeScale"></div>
				<span>Range</span>
			</th>
			<th>Price</th>
			<th>Weight</th>
			<th>Strength</th>
			<th>Stem Count</th>
			<th>Axle Count</th>
			<th>Extendable Sling</th>
			<th>Is Offset</th>
		</tr>
	</tfoot>
	<tbody></tbody>
</table>

<div id="advancedSearch">

	<select id="manufacturerSearchOption"></select>
	<select id="modelSearchOption"></select>
	<select id="nameSearchOption"></select>
	<input id="rangeInput" ></input>

</div>

</body>
</html>